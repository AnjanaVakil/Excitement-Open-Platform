/**
 * 
 */
package eu.excitementproject.eop.distsim.storage;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.io.Serializable;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.Map.Entry;

import eu.excitementproject.eop.distsim.util.Configuration;
import eu.excitementproject.eop.distsim.util.Pair;
import eu.excitementproject.eop.distsim.util.Serialization;
import eu.excitementproject.eop.distsim.util.SerializationException;

import ac.biu.nlp.nlp.general.configuration.ConfigurationException;
import ac.biu.nlp.nlp.general.configuration.ConfigurationParams;

/**
 * A file-based implementation of the {@link PersistenceDevice} interface, where each line is composed
 * of an id and a serialized data object 
 * 
 * 
 * @author Meni Adler
 * @since 10/09/2012
 *
 */
public class File implements PersistenceDevice {

	/**
	 * @throws IOException 
	 * 
	 */
	public File(java.io.File file, boolean bRead) {
		this.file = file;
		this.bRead = bRead;
	}

	public File(ConfigurationParams params) throws ConfigurationException {
		this.file = new java.io.File(params.get(Configuration.FILE));
		this.bRead = params.get(Configuration.READ_WRITE).equals("read");
	}
	
	/* (non-Javadoc)
	 * @see org.excitement.distsim.storage.PersistenceDevice#open()
	 */
	@Override
	public void open()  throws IOException {
		if (bRead) {
			reader = new BufferedReader(new FileReader(file));
			writer = null;
		} else {
			reader = null;
			writer = new PrintWriter(new FileWriter(file));
		}		
	}

	/* (non-Javadoc)
	 * @see org.excitement.distsim.storage.PersistenceDevice#save(int, java.io.Serializable)
	 */
	@Override
	public synchronized void write(int id, Serializable data) throws SerializationException, IOException {
		if (writer == null)
			throw new IOException("Writing device is not opened");
		writer.print(id);
		writer.print("\t");
		writer.print(Serialization.serialize(data));
		writer.print("\n");
		
	}

	/* (non-Javadoc)
	 * @see org.excitement.distsim.storage.PersistenceDevice#read()
	 */
	@Override
	public synchronized Pair<Integer, Serializable> read() throws SerializationException, IOException {
		if (reader == null)
			throw new IOException("Writing device is not opened");
		String line = reader.readLine();
		if (line == null)
			return null;
		String[] toks = line.split("\t");
		if (toks.length != 2)
			throw new SerializationException("wrong line format: " + line);
		return new Pair<Integer, Serializable>(Integer.parseInt(toks[0]), Serialization.deserialize(toks[1]));
	}

	/* (non-Javadoc)
	 * @see org.excitement.distsim.storage.PersistenceDevice#getType()
	 */
	@Override
	public PersistenceDeviceType getType() {
		return PersistenceDeviceType.FILE;
	}

	/* (non-Javadoc)
	 * @see org.excitement.distsim.storage.PersistenceDevice#close()
	 */
	@Override
	public void close() throws IOException {
		if (reader != null) 
			reader.close();
		if (writer != null) 
			writer.close();
	}

	protected java.io.File file;
	protected boolean bRead;
	protected BufferedReader reader;
	protected PrintWriter writer;
}
