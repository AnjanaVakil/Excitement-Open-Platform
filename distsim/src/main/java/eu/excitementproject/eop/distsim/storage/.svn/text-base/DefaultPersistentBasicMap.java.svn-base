/**
 * 
 */
package eu.excitementproject.eop.distsim.storage;

import java.io.Serializable;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;


import eu.excitementproject.eop.distsim.items.Countable;
import eu.excitementproject.eop.distsim.items.Externalizable;
import eu.excitementproject.eop.distsim.items.Identifiable;
import eu.excitementproject.eop.distsim.items.InvalidIDException;
import eu.excitementproject.eop.distsim.items.UndefinedKeyException;
import eu.excitementproject.eop.distsim.util.Pair;

import ac.biu.nlp.nlp.general.immutable.ImmutableIterator;

import redis.clients.jedis.Jedis;
import redis.clients.jedis.JedisPool;
import redis.clients.jedis.JedisPoolConfig;

/**
 * Implements the saving and loading operations of the countable-identifiable storage
 *
 * @author Meni Adler
 * @since 22/07/2012
 * 
 *
 */
public abstract class DefaultPersistentBasicMap<V extends Serializable> implements PersistentBasicMap<V> {
	

	private static final long serialVersionUID = 1L;

	/* (non-Javadoc)
	 * @see org.excitement.distsim.storage.Persistence#saveState(org.excitement.distsim.storage.PersistenceDevice)
	 */
	@Override
	public void saveState(PersistenceDevice... devices) throws SavingStateException {
		if (devices.length != 1)
			throw new SavingStateException(devices.length + " persistence devices was providied for saving, but only one is expected");
		Iterator<Pair<Integer,V>> it = iterator();
		while (it.hasNext()) {
			Pair<Integer,V> item = it.next();
			try {
				devices[0].write(item.getFirst(),item.getSecond());
			} catch (Exception e) {
				throw new SavingStateException(e);
			}
		}
	}

	/* (non-Javadoc)
	 * @see org.excitement.distsim.storage.Persistence#loadState()
	 */
	@Override
	public void loadState(PersistenceDevice... devices) throws LoadingStateException {
		if (devices.length != 1)
			throw new LoadingStateException(devices.length + " persistence devices was providied for loading, but only one is expected");
		try {			
			Pair<Integer, Serializable> pair = null;
			while ((pair = devices[0].read()) != null)
				try {
					put(pair.getFirst(), (V)pair.getSecond());
				} catch (ClassCastException e) {
					throw new LoadingStateException(e);
				}
		} catch (Exception e) {
			throw new LoadingStateException(e);
		}
	}	
	
}
